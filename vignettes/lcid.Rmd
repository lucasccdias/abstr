---
title: "Reproducing Montlake Eastside Seattle, US"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reproducing Montlake Eastside Seattle, US}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
author: 
- "Robin Lovelace, Trevor Nederlof and Nathanael Sheehan"
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction 
The `abstr` package was originally developed as part of the Active Travel Orientated Development paper by Talbolt et al. (2021): to assess the active travel prevision of new and proposed development sites in England. The [ActDev]() website, which visualizes all 38 sites used in the study, is fueled by a reproducible R project. Fundamentally, `abstr` transforms dataframes into simulation files that match the A/B Street schema (link). Package data includes an example site, the Leeds Climate and Innovation Destrict from the ActDev project 


```{r, message=FALSE, warning=FALSE}
library(abstr)
library(tmap)

output_sf = abstr::ab_scenario(
  od = leeds_od,
  zones = leeds_site_area,
  zones_d = leeds_zones,
  origin_buildings = leeds_buildings,
  destination_buildings = leeds_buildings,
  scenario = "base",
  output = "sf"
)

bb = tmaptools::bb(leeds_houses, 10)
tm_shape(leeds_buildings, bbox = bb) + tm_polygons() +
  tm_shape(leeds_houses) + tm_polygons(col = "blue") +
  tm_shape(output_sf) + tm_lines(col = "mode") 
```


# Preparing datasets
```{r, message=FALSE, warning=FALSE}
library(abstr)
library(tmap)
```

## Site area
```{r, message=FALSE,warning=FALSE}
site = sf::read_sf("https://raw.githubusercontent.com/cyipt/actdev/main/data-small/lcid/site.geojson") # Read site geojson from actdev repo
```

## Buildings and Houses
```{r}
# buildings = osmextract::oe_get(study_area, layer = "multipolygons")
osm_polygons = osmextract::oe_get(sf::st_centroid(study_area), layer = "multipolygons")

summary(desire_lines)

# from od/data-raw folder
building_types = c(
  "office",
  "industrial",
  "commercial",
  "retail",
  "warehouse",
  "civic",
  "public"
)
osm_buildings = osm_polygons %>%
  filter(building %in% building_types)
pct_zone = pct::pct_regions[site_area %>% sf::st_centroid(), ]
zones = pct::get_pct_zones(pct_zone$region_name)
zones = pct::get_pct_zones(pct_zone$region_name, geography = "msoa")
zones_of_interest = zones[zones$geo_code %in% c(desire_lines$geo_code1, desire_lines$geo_code2), ] %>%
  select(1:10)
buildings_in_zones = osm_buildings[zones_of_interest, , op = sf::st_within]

mapview::mapview(zones_of_interest) +
  mapview::mapview(buildings_in_zones)
buildings_in_zones = buildings_in_zones %>%
  filter(!is.na(osm_way_id)) %>%
  select(osm_way_id, building)

osm_polygons_in_site = osm_polygons[site_area, , op = sf::st_within]
nrow(osm_polygons_in_site)
osm_polygons_resi_site = osm_polygons_in_site %>%
  # filter(building == "residential") %>%
  select(osm_way_id, building)
```


## Desire lines

